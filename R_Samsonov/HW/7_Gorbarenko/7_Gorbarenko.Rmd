---
title: "HomeWork 7"
author: "Gorbarenko Artem"
date: "26 10 2020"
output: html_document
---
### Температурная аномалия в Москве
```{r, echo = FALSE,include=FALSE}
library(tidyverse)
library(googlesheets4)
library(lubridate)
```

Загрузка каталога метеостанций и метеоданных:
```{r, include=FALSE}
catalog = read_sheet('1Q6HCY4jxiYefjPdWrN5erwgEee-Gz_BywqZW2mQcftw') 
meteo_data <- lapply(as.character(catalog$ID), function(X)  read_sheet('1FWC_YBrlINnjR5POC2kxa_LnLC7n5fFA90oNA7dLTP0', 
                                                                        sheet = X, col_types = c('ccncccnninncnnnnncc'))) 
```
Обработка метеоданных, сопоставление их с соответсвующей метеостанцией
```{r}
meteo_data = meteo_data %>% 
  set_names(catalog$ID) %>% 
  bind_rows(.id = 'id') %>% 
  mutate(id = as.numeric(id)) %>% 
  full_join(catalog, by = c('id' = 'ID')) %>% 
  mutate(Datetime = as.POSIXct(Datetime)) %>% 
  relocate(id, .before = NAME) %>% 
  set_names(c('Datetime', 'Wdir', 'Wspd', 'Vis', 'Phen', 'Cloud', 'T', 'Td', 'F', 'Te', 'Tes', 
              'Comf', 'P', "Po", 'Tmin', 'Tmax', 'R', 'R24', 'S', 'ID', 'NAME', 'LON', 'LAT', 'H'))
```
Для дальнейшей работы нас будут интересовать лишь данные со станций Москва-Балчуг и Малое Сареево. Поэтому мы создаем отдельный дата фрейм только по этим станциям. Также, необходимо будет проанализировать исключительно ночные характиеристики, для этого мы фильтруем полученный ранее фрейм и оставляем лишь ночные данные. 
```{r}
flt_df <- meteo_data %>% 
  filter(str_detect(NAME, 'Балчуг') | str_detect(NAME, 'Сареево'))
flt_df_night <- flt_df %>% 
  filter(hour(Datetime) == 0 | hour(Datetime) == 3)

```

Для наглядного отображения плотности температур были построены графики как за весь период наблюдения, так и за ночной в отдельности. 
```{r}
ggplot(flt_df, mapping = aes(x = Datetime, y = `T`, color = NAME)) +
  geom_point() +
  ggtitle('Плотности распределения температур на станциях "Малое Сараево", "Балчуг"') +
  ylab('C°') +
  xlab('Месяц') +
  labs(color = 'Метеостанция') + 
  scale_color_manual(values = c("orange", "purple"))

```
Как видно из первого графика, для метеостанции Москва - Балчуг характерны более высокие температуры чем для станции Малое Сареево. Причиной эту является так называемый "городской остров тепла". Температуры города, как правило, выше из-за высокой антропогенной нагрузки на атмосферу. Если более детально изучать график, можно обратить внимание, что температуры на станции Москва-Балчуг в августе и сентябре выше, в то время как температуры в октябре практически одинаковые. Причиной этому является то, что в ясную погоду, характерную для конца лета и начала осени, разница температур всегда наблюдается более явно
```{r}
ggplot(flt_df_night, mapping = aes(x = Datetime, y = `T`, color = NAME)) +
  geom_point() +
  ggtitle('Плотности распределенияночных температур на станциях "Малое Сараево", "Балчуг"') +
  ylab('C°') +
  xlab('Месяц') +
  labs(color = 'Метеостанция') + 
  scale_color_manual(values = c("red", "blue"))
```

Глядя на второй график, также можно наблюдать влияние "острова тепла" на суточный ход температуры, так как температуры со станции Москва-Балчуг выше чем со станции Малое Сареево. 

По полученным данным также были составлены диаграмы размаха, по которым можно судить о средних значениях выборки, максимальных и минимальных значениях, количестве выбросов и тд.

```{r}

ggplot(flt_df, mapping = aes(NAME, `T`, color = NAME)) +
  geom_boxplot( width = 0.4, col = 'black', fill = c("orange", "purple")) +
  ylab('C°') +
  theme(axis.title.x = element_blank()) +
  ggtitle('Диаграммы размаха температур на метеостанциях') +
  theme(legend.position="none") 
 
```

```{r}
ggplot(flt_df_night, mapping = aes(NAME, `T`, color = NAME)) +
  geom_boxplot( width = 0.4, col = 'black', fill = c("red", "blue")) +
  ylab('C°') +
  theme(axis.title.x = element_blank()) +
  ggtitle('Диаграммы размаха ночных температур на метеостанциях') +
  theme(legend.position="none") 
```

Представленные графики еще раз иллюстрируют присутствие "острова тепла". Особый интерес представляет второй график, размах ночных температур. Как видно, разница средних значений температур в ночное время превышает дневное. Причиной этому является высокая активность мегаполиса даже ночью. 


К исследуемым данным было применено несколько статистических тестов, а именно тест Стьюдента и тест Фишера. 
```{r}
t.test(flt_df %>% filter(NAME == 'Малое Сареево') %>% pull(`T`),
       flt_df %>% filter(NAME == 'Москва (центр, Балчуг)') %>% pull(`T`))

t.test(flt_df_night %>% filter(NAME == 'Малое Сареево') %>% pull(`T`),
       flt_df_night %>% filter(NAME == 'Москва (центр, Балчуг)') %>% pull(`T`))


```
Полученные значения теста (P-value)  позволяет принять  гипотезу о неравенстве средних

```{r}
var.test(flt_df %>% filter(NAME == 'Малое Сареево') %>% pull(`T`),
         flt_df %>% filter(NAME == 'Москва (центр, Балчуг)') %>% pull(`T`))  

var.test(flt_df_night %>% filter(NAME == 'Малое Сареево') %>% pull(`T`),
       flt_df_night %>% filter(NAME == 'Москва (центр, Балчуг)') %>% pull(`T`))

```
Значение P-value для всех значений оказалось не столь велико, но все же можно допустить что данная выборка имеет статистическую значимость. 
Значения для ночных температур достаточно высоки и позволяют утверждать об однозначной статистической значимости. 


Далее были составлены графики, показывающие взаимосвязь температур и скорости ветра. 
```{r}
ggplot(dif_temp, mapping = aes(mean_wind, delta_temp)) +
  geom_point(color = 'orange') + 
  geom_smooth(method = 'loess', color = 'purple',  span = 1) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей температур (Малое Сареево и Балчуг)') +
  xlab('Скорость ветра, м/с') +
  ylab('Разница температур, C°')

ggplot(dif_temp_night, mapping = aes(mean_wind, delta_temp)) +
  geom_point(color = 'blue') + 
  geom_smooth(method = 'loess', color = 'red',  span = 1) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей ночных температур (Малое Сареево и Балчуг)') +
  xlab('Скорость ветра, м/с') +
  ylab('Разница температур, C°')
```

Для дальнейших корреляционных тестов необходимо сделать регрессию линейной. 
```{r}
ggplot(dif_temp, mapping = aes(mean_wind, delta_temp)) +
  geom_point(color = 'orange') + scale_x_log10() + 
  geom_smooth(method = 'loess', color = 'purple',  span = 2) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей температур (Малое Сареево и Балчуг)') +
  xlab('Скорость ветра, м/с') +
  ylab('Разница температур, C°')

ggplot(dif_temp_night, mapping = aes(mean_wind, delta_temp)) +
  geom_point(color = 'blue') + scale_x_log10() + 
  geom_smooth(method = 'loess', color = 'red',  span = 2) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей ночных температур (Малое Сареево и Балчуг)') +
  xlab('Скорость ветра, м/с') +
  ylab('Разница температур, C°')

```



Для разницы температур по 2ум метеостанциям и скорости ветра был посчитан коэфициент корреляции 
```{r}
cor.test(log10(dif_temp$mean_wind), dif_temp$delta_temp)
```
По результам теста, коэфициент корреляции равен -0,41, что позволяет нам утверждать о сравнительно незначительной зависимости температуры от скорости ветра.

```{r}
cor.test(log10(dif_temp_night$mean_wind), dif_temp_night$delta_temp)
```
коэфициент корреляции для ночной выборки еще более незначителен. 

Получение модели линейной регрессии:
```{r}
linear_model = lm(log10(dif_temp$mean_wind) ~ dif_temp$delta_temp)
summary(linear_model)
```

По итогу вычислений были получены значения медианы, 1 и 3 квартилей, среднеквадратическое отклонение и др. 