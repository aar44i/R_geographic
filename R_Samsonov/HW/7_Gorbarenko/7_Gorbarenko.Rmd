---
title: "HomeWork 7"
author: "Gorbarenko Artem"
date: "26 10 2020"
output: html_document
---
### Температурная аномалия в Москве
```{r, echo = FALSE,include=FALSE}
library(tidyverse)
library(googlesheets4)
library(lubridate)
```

Загрузка каталога метеостанций и метеоданных:
```{r, include=FALSE}
catalog <- read_sheet('1Q6HCY4jxiYefjPdWrN5erwgEee-Gz_BywqZW2mQcftw')
meteo_data <- lapply(as.character(catalog$ID), function(X) read_sheet('1FWC_YBrlINnjR5POC2kxa_LnLC7n5fFA90oNA7dLTP0', sheet = X, col_types = 'ccncccnninncnnnnncc')) %>% 
  set_names(catalog$ID) %>% 
  bind_rows(.id = 'id') %>% 
  mutate(id = as.numeric(id)) %>% 
  full_join(catalog, by = c('id' = 'ID')) %>% 
  mutate(Datetime = as.POSIXct(Datetime)) %>% 
  relocate(id, .before = NAME) %>% 
  set_names(c('Datetime', 'Wdir', 'Wspd', 'Vis', 'Phen', 'Cloud', 'T', 'Td', 'F', 'Te', 'Tes', 'Comf', 'P', "Po", 'Tmin', 'Tmax', 'R', 'R24', 'S', 'ID', 'NAME', 'LON', 'LAT', 'H'))
```
Для дальнейшей работы нас будут интересовать лишь данные со станций Москва-Балчуг и Малое Сареево. Поэтому мы создаем отдельный дата фрейм только по этим станциям. Также, необходимо будет проанализировать исключительно ночные характиеристики, для этого мы фильтруем полученный ранее фрейм и оставляем лишь ночные данные. 
```{r}
filter_data <- meteo_data %>% 
  filter(str_detect(NAME, 'Балчуг') | str_detect(NAME, 'Сареево'))
print(filter_data)
filter_data_night <- filter_data %>% 
  filter(hour(Datetime) == 0 | hour(Datetime) == 3)
print(filter_data_night)
```

Для наглядного отображения плотности температур были построены графики как за весь период наблюдения, так и за ночной в отдельности. 
```{r}
ggplot(filter_data, mapping = aes(Datetime, `T`, color = NAME)) +
  geom_point(alpha = 0.1) +
  geom_density_2d() +
  ggtitle('Плотности распределения температур на станциях "Малое Сараево", "Балчуг"') +
  ylab('C°') +
  xlab('Месяц') +
  labs(color = 'Метеостанция')

```
Как видно из первого графика, для метеостанции Москва - Балчуг характерны более высокие температуры чем для станции Малое Сареево. Причиной эту является так называемый "городской остров тепла". Температуры города, как правило, выше из-за высокой антропогенной нагрузки на атмосферу. Если более детально изучать график, можно обратить внимание, что температуры на станции Москва-Балчуг в августе и сентябре выше, в то время как температуры в октябре практически одинаковые. Причиной этому является то, что в ясную погоду, характерную для конца лета и начала осени, разница температур всегда наблюдается более явно

Построение графика плотности распределения ночных температур:
```{r}
ggplot(filter_data_night, mapping = aes(Datetime, `T`, color = NAME)) +
  geom_point(alpha = 0.5) +
  geom_density_2d() +
  ggtitle('Плотности распределения ночных температур на станциях "Малое Сараево", "Балчуг"') +
  ylab('C°') +
  xlab('Месяц') +
  labs(color = 'Метеостанция')
```

Глядя на второй график, также можно наблюдать влияние "острова тепла" на суточный ход температуры, так как температуры со станции Москва-Балчуг выше чем со станции Малое Сареево. 

По полученным данным также были составлены диаграмы размаха, по которым можно судить о средних значениях выборки, максимальных и минимальных значениях, количестве выбросов и тд.

```{r}

ggplot(filter_data, mapping = aes(NAME, `T`, fill = NAME)) +
  geom_boxplot(alpha = 0.4, width = 0.6) +
  ylab('C°') +
  theme(axis.title.x = element_blank()) +
  ggtitle('Диаграммы размаха температур на метеостанциях') +
  theme(legend.position="none")
 
```

```{r}
ggplot(filter_data_night, mapping = aes(NAME, `T`, fill = NAME)) +
  geom_boxplot(alpha = 0.4, width = 0.6) +
  ylab('C°') +
  theme(axis.title.x = element_blank()) +
  ggtitle('Диаграммы размаха температур на метеостанциях') +
  theme(legend.position="none")
```

Представленные графики еще раз иллюстрируют присутствие "острова тепла". Особый интерес представляет второй график, размах ночных температур. Как видно, разница средних значений температур в ночное время превышает дневное. Причиной этому является высокая активность мегаполиса даже ночью. 


К исследуемым данным было применено несколько статистических тестов, а именно тест Стьюдента и тест Фишера. 
```{r}
t.test(filter_data %>% filter(ID == 27605) %>% pull(`T`),
       filter_data %>% filter(ID == 27518) %>% pull(`T`))

t.test(filter_data_night %>% filter(ID == 27605) %>% pull(`T`),
       filter_data_night %>% filter(ID == 27518) %>% pull(`T`))


```
Полученные значения теста (P-value)  позволяет принять  гипотезу о неравенстве средних

```{r}
var.test(filter_data %>% filter(ID == 27605) %>% pull(`T`),
       filter_data %>% filter(ID == 27518) %>% pull(`T`))

var.test(filter_data_night %>% filter(ID == 27605) %>% pull(`T`), 
         filter_data_night %>% filter(ID == 27518) %>% pull(`T`))
```
Значение P-value для всех значений оказалось не столь велико, но все же можно допустить что данная выборка имеет статистическую значимость. 
Значения для ночных температур достаточно высоки и позволяют утверждать об однозначной статистической значимости. 


### Создание расчетного датафрейма (разниц температур)

Создание и преобразование датафрейма разниц температур на основе ранее скачанных данных, добавление столбцы со средней скоростью ветра:
```{r, message = F, warning = F}
dif_df = inner_join(filter_data %>% 
                          select(Datetime, `T`, ID, NAME) %>% 
                          filter(ID == 27605),
                          filter_data %>% 
                          select(Datetime, `T`, ID, NAME) %>% 
                          filter(ID == 27518),
                          by = 'Datetime') %>% 
  mutate(temp_dif = `T.x` - `T.y`) %>% 
  select(Datetime, temp_dif) %>% 
  inner_join(meteo_data %>% group_by(Datetime) %>% summarise(mean_wind_spd = round(mean(Wspd, na.rm = T), 2)))
```

Фильтрация и создание датафрейма с ночными температурами:
```{r, message = F}
dif_df_night <- dif_df %>% 
  filter(hour(Datetime) == 0 | hour(Datetime) == 3)
head(dif_df_night)
```

Построение диграммы рассеяния с линией регрессии между разницей температурой и высчитанной средней скоростью ветра в регионе (общая выборка температур):
```{r}
ggplot(dif_df, mapping = aes(mean_wind_spd, temp_dif)) +
  geom_point(shape = 1, size = 0.8, color = 'red') +
  geom_smooth(method = 'loess', color = 'blue', size = 0.8, span = 0.5) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей температур (Малое Сареево и Балчуг)') +
  xlab('Скорость ветра, м/с') +
  ylab('Разница температур, C°')
```

На основе графика можно сказать, что между этими двумя показателями отмечается нелинейная зависимость, также важно сказать, что при высоких значениях скорости отмечается некоторое количество выбросов, которые несколько искажают картину.Чем меньше скорость ветра - тем меньше разница температур

Построение диграммы рассеяния с линией регрессии между разницей температурой и высчитанной средней скоростью ветра в регионе (ночные температуры):
```{r}
ggplot(dif_df_night, mapping = aes(mean_wind_spd, temp_dif)) +
  geom_point(shape = 1, size = 0.8, color = 'red') +
  geom_smooth(method = 'loess', color = 'blue', size = 0.8, span = 0.9) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей ночных температур (Малое Сареево и Балчуг)') +
  xlab('Скорость ветра, м/с') +
  ylab('Разница температур, C°')
```

Между двумя показателями можно выявить нелинейную регрессию - при наименьших скоростях ветра отмечаются наибольшие разницы температур.

Для применения коррелляцианных тестов необходимо провести линеаризацию (сделать регрессию линейной). Для этого был выбран способ логарифмирования одного из аргументов, в данном случае этот способ подходит больше всего.

Для общей выборки:
```{r}
ggplot(dif_df, mapping = aes(log10(mean_wind_spd), temp_dif)) +
  geom_point(shape = 1, size = 0.8, color = 'red') +
  geom_smooth(method = 'lm', color = 'blue', size = 0.8) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей температур (Малое Сареево и Балчуг)') +
  xlab(expression('log'[10]*'(Скорость ветра), м/с')) +
  ylab('Разница температур, C°')
```

Для ночной выборки:
```{r}
ggplot(dif_df_night, mapping = aes(log10(mean_wind_spd), temp_dif)) +
  geom_point(shape = 1, size = 0.8, color = 'red') +
  geom_smooth(method = 'lm', color = 'blue', size = 0.8) +
  ggtitle('Диаграмма рассеяния между скоростью ветра\nи разницей температур (Малое Сареево и Балчуг)') +
  xlab(expression('log'[10]*'(Скорость ветра), м/с')) +
  ylab('Разница температур, C°')  
```

### Проведение корреляционного теста и получение линейной модели регрессии

Проведение корреляционного теста (Пирсона) для общей выборки:
```{r}
cor.test(log10(dif_df$mean_wind_spd), dif_df$temp_dif)
```

На основе полученных данных можно сказать что величины имеют значительную обратную связь, так как значение всего -0.74.

Проведение корреляционного теста для ночной выборки:
```{r}
cor.test(log10(dif_df_night$mean_wind_spd), dif_df_night$temp_dif)
```

Выявлена значительная обратная связь. Можно отметить, что в ночное время связь более значительна (-0.79).

Получение модели линейной регрессии:
```{r, message = F}
linear_model = lm(log10(dif_df$mean_wind_spd) ~ dif_df$temp_dif)
summary(linear_model)
```

Получены данные: коэффициенты, интервал и статистика по отклонениям, среднеквадратическое отклонение и др.
